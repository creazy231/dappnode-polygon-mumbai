#!/bin/sh

# exit script on any error
set -e

# Set Heimdall Home Directory
HEIMDALLD_HOME=/root/.heimdalld

if [ ! -f "$HEIMDALLD_HOME/config/config.toml" ];
then
    echo "setting up initial configurations"
    heimdalld init
    cd $HEIMDALLD_HOME/config

    echo "removing autogenerated genesis file"
    rm genesis.json

    echo "downloading launch genesis file"
    wget https://raw.githubusercontent.com/maticnetwork/launch/master/testnet-v4/without-sentry/heimdall/config/genesis.json

    echo "overwriting toml config lines"
    # config.toml
    # CORS
    sed -i "s#^cors_allowed_origins.*#cors_allowed_origins = [\"*\"]#" config.toml
    # SEEDS
    sed -i "s#^seeds.*#seeds = \"${BOOTNODES:-"ec0b7ee065727193b752d6bdd15923606c99cec7@162.55.210.19:26656,4cd60c1d76e44b05f7dfd8bab3f447b119e87042@54.147.31.250:26656,b18bbe1f3d8576f4b73d9b18976e71c65e839149@34.226.134.117:26656"}\"#" config.toml
    # heimdall-config.toml
    # BOR
    sed -i "s#^bor_rpc_url.*#bor_rpc_url = \"http://localhost:8545\"#" heimdall-config.toml
    # ETH1
    sed -i "s#^eth_rpc_url.*#eth_rpc_url = \"https://goerli.infura.io/v3/f1adf5ae200747339faa560c2fa3c975\"#" heimdall-config.toml
    # RABBITMQ
    sed -i "s#^amqp_url.*#amqp_url = \"amqp://guest:guest@rabbitmq:6672\"#" heimdall-config.toml
fi

echo "$BOOTSTRAP"
echo "${SNAPSHOT_DATE}"

if [ "${BOOTSTRAP}" == 1 ] && [ -n "${SNAPSHOT_DATE}" ];
then
  echo "downloading snapshot from ${SNAPSHOT_DATE}"
  mkdir -p ${HEIMDALLD_HOME}/data
  wget -c https://matic-blockchain-snapshots.s3.amazonaws.com/matic-mumbai/heimdall-snapshot-${SNAPSHOT_DATE}.tar.gz -O - | tar -xz -C ${HEIMDALLD_HOME}/data
fi

if [ -n "$REST_SERVER" ];
then
  EXEC="heimdalld rest-server --chain-id=80001 --laddr=tcp://0.0.0.0:1317 --max-open=1000 --node=tcp://heimdalld:26657 --trust-node=true"
else
  EXEC="heimdalld start --moniker=$MONIKER --fast_sync --p2p.laddr=tcp://0.0.0.0:26656 --p2p.upnp=false --pruning=syncable --rpc.laddr=tcp://0.0.0.0:26657 --with-tendermint=true"
fi

${EXEC}
